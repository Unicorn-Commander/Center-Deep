version: '3.8'

services:
  # Nginx reverse proxy - serves everything on port 8888
  nginx:
    image: nginx:alpine
    container_name: center-deep-proxy
    restart: unless-stopped
    ports:
      - "8888:80"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
    networks:
      - center-deep-network
    depends_on:
      - center-deep
      - searxng
      - redis

  # Redis for caching
  redis:
    image: redis:7-alpine
    container_name: center-deep-redis
    restart: unless-stopped
    command: redis-server --maxmemory 2gb --maxmemory-policy allkeys-lru
    volumes:
      - redis_data:/data
    networks:
      - center-deep-network

  # SearXNG search backend (internal only)
  searxng:
    image: searxng/searxng:latest
    container_name: center-deep-searxng
    restart: unless-stopped
    volumes:
      - ./searxng:/etc/searxng:rw
    networks:
      - center-deep-network
    environment:
      - BIND_ADDRESS=0.0.0.0:8080
      - INSTANCE_NAME=Center Deep
      - SEARXNG_REDIS_URL=redis://redis:6379/0

  # Center Deep app with admin dashboard (internal only)
  center-deep:
    build: .
    container_name: center-deep-app
    restart: unless-stopped
    volumes:
      - ./instance:/app/instance
      - ./static:/app/static:ro
      - ./templates:/app/templates:ro
      - /var/run/docker.sock:/var/run/docker.sock:ro
    networks:
      - center-deep-network
    environment:
      - FLASK_ENV=production
      - REDIS_HOST=redis
      - SEARXNG_URL=http://searxng:8080
    env_file:
      - .env

  # Tool servers with consolidated port mapping
  tool-search:
    build: ./toolserver/search
    container_name: center-deep-tool-search
    restart: unless-stopped
    networks:
      - center-deep-network
    environment:
      - SEARXNG_URL=http://searxng:8080
    env_file:
      - .env

  tool-deep-search:
    build: ./toolserver/deep-search
    container_name: center-deep-tool-deep-search
    restart: unless-stopped
    networks:
      - center-deep-network
    environment:
      - SEARXNG_URL=http://searxng:8080
    env_file:
      - .env

  tool-report:
    build: ./toolserver/report
    container_name: center-deep-tool-report
    restart: unless-stopped
    networks:
      - center-deep-network
    environment:
      - SEARXNG_URL=http://searxng:8080
    env_file:
      - .env

  tool-academic:
    build: ./toolserver/academic
    container_name: center-deep-tool-academic
    restart: unless-stopped
    networks:
      - center-deep-network
    environment:
      - SEARXNG_URL=http://searxng:8080
    env_file:
      - .env

networks:
  center-deep-network:
    driver: bridge

volumes:
  redis_data: