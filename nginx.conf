events {
    worker_connections 1024;
}

http {
    include /etc/nginx/mime.types;
    default_type application/octet-stream;

    upstream searxng {
        server searxng:8080;
    }

    upstream center_deep {
        server center-deep:8890;
    }

    upstream tool_search {
        server tool-search:8001;
    }

    upstream tool_deep_search {
        server tool-deep-search:8002;
    }

    upstream tool_report {
        server tool-report:8003;
    }

    upstream tool_academic {
        server tool-academic:8004;
    }

    server {
        listen 80;
        server_name _;

        # Main Center Deep interface (custom UI)
        location / {
            # Check if this is a search request
            if ($arg_q) {
                proxy_pass http://searxng;
                break;
            }
            
            # Otherwise show our custom homepage
            proxy_pass http://center_deep/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }

        # Search API and autocomplete
        location /search {
            proxy_pass http://searxng/search;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }

        location /autocompleter {
            proxy_pass http://searxng/autocompleter;
            proxy_set_header Host $host;
        }

        # Admin dashboard and user management
        location /admin {
            proxy_pass http://center_deep/admin;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }

        location /login {
            proxy_pass http://center_deep/login;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }

        location /logout {
            proxy_pass http://center_deep/logout;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }

        location /preferences {
            proxy_pass http://center_deep/preferences;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }

        # API endpoints
        location /api/ {
            proxy_pass http://center_deep/api/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header Content-Type application/json;
        }

        # Static assets from Center Deep
        location /static/ {
            proxy_pass http://center_deep/static/;
            proxy_cache_valid 200 1d;
            expires 1d;
            add_header Cache-Control "public, immutable";
        }

        # SearXNG static files
        location /searxng-static/ {
            proxy_pass http://searxng/static/;
            proxy_cache_valid 200 1d;
            expires 1d;
        }

        # Tool server endpoints (for OpenWebUI)
        location /tools/search/ {
            proxy_pass http://tool_search/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            
            # WebSocket support for streaming
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
        }

        location /tools/deep-search/ {
            proxy_pass http://tool_deep_search/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
        }

        location /tools/report/ {
            proxy_pass http://tool_report/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
        }

        location /tools/academic/ {
            proxy_pass http://tool_academic/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
        }

        # Health check endpoint
        location /health {
            access_log off;
            return 200 "OK\n";
            add_header Content-Type text/plain;
        }
    }
}